<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: auth.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: auth.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// auth.js – Login, Gast-Modus, Registrierung und Logout.
// Nutzt Firebase Auth. Für Gast wird nur ein einfaches Objekt genutzt.
/**
 * @module auth
 */

import { auth } from "./firebase.js";
import {
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged,
  createUserWithEmailAndPassword,
  updateProfile,
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

// Speicher für Gast-User (liegt nur im Arbeitsspeicher / Session Storage)
let guestSession = null;
const GUEST_KEY = "join_guest_session";

// Beim Laden versuchen wir eine evtl. vorhandene Gast-Session wiederherzustellen
const storedGuest = sessionStorage.getItem(GUEST_KEY);
if (storedGuest) {
  try {
    guestSession = JSON.parse(storedGuest);
  } catch (_) {
    guestSession = null;
  }
}

/**
 * Meldet einen Benutzer mit E-Mail &amp; Passwort über Firebase an.
 * @async
 * @function login
 * @param {string} email E-Mail-Adresse
 * @param {string} password Passwort im Klartext
 * @returns {Promise&lt;Object>} Angemeldeter User
 * @throws Firebase Auth Fehler
 */
export async function login(email, password) {
  clearStatus();
  try {
    const cred = await signInWithEmailAndPassword(auth, email, password);
    setStatus("Login erfolgreich", false);
    return cred.user;
  } catch (err) {
    setStatus(mapFirebaseError(err), true);
    throw err;
  }
}

/**
 * Aktiviert den Gastmodus (Session nur im Speicher / sessionStorage).
 * @function guestLogin
 * @returns {void}
 */
export function guestLogin() {
  clearStatus();
  guestSession = {
    uid: "guest-user",
    displayName: "Guest User",
    email: "guest@example.com",
    provider: "guest",
  };
  sessionStorage.setItem(GUEST_KEY, JSON.stringify(guestSession));
  dispatchAuthEvent();
}

/**
 * Meldet Benutzer (Firebase oder Gast) ab und bereinigt Session.
 * @async
 * @function logout
 * @returns {Promise&lt;void>}
 */
export async function logout() {
  clearStatus();
  try {
    guestSession = null;
    sessionStorage.removeItem(GUEST_KEY);
    await signOut(auth);
  } catch (e) {
    // ignore
  } finally {
    dispatchAuthEvent();
  }
}

/**
 * Liefert den aktuell aktiven Benutzer (Firebase oder Gast).
 * @function getActiveUser
 * @returns {object|null} Userobjekt oder null
 */
export function getActiveUser() {
  if (guestSession) return guestSession;
  return auth.currentUser || null;
}

/**
 * Dispatcht ein globales CustomEvent 'auth-changed' mit aktuellem User.
 * @private
 * @function dispatchAuthEvent
 * @fires auth-changed
 */
function dispatchAuthEvent() {
  window.dispatchEvent(
    new CustomEvent("auth-changed", { detail: { user: getActiveUser() } })
  );
}

// Reagiert auf Firebase Auth Änderungen.
onAuthStateChanged(auth, (user) => {
  // Echte Anmeldung ersetzt Gast-Session
  if (user &amp;&amp; guestSession) {
    guestSession = null;
    sessionStorage.removeItem(GUEST_KEY);
  }
  dispatchAuthEvent();
});

/**
 * Setzt Statusnachricht im Login-Bereich.
 * @private
 * @function setStatus
 * @param {string} msg Text
 * @param {boolean} isError Ob Fehlerstil genutzt wird
 */
function setStatus(msg, isError) {
  const el = document.getElementById("loginStatus");
  if (el) {
    el.textContent = msg;
    el.classList.toggle("error", !!isError);
  }
}

/**
 * Löscht Statusnachricht im Login-Bereich.
 * @private
 * @function clearStatus
 */
function clearStatus() {
  setStatus("", false);
}

/**
 * Übersetzt einen Firebase Fehlercode in kurze deutsche Meldung.
 * @private
 * @function mapFirebaseError
 * @param {any} err Fehlerobjekt von Firebase
 * @returns {string} Meldung
 */
function mapFirebaseError(err) {
  if (!err || !err.code) return "Unbekannter Fehler";
  const map = {
    "auth/invalid-email": "Ungültige E-Mail-Adresse",
    "auth/user-disabled": "Benutzer deaktiviert",
    "auth/user-not-found": "Benutzer nicht gefunden",
    "auth/wrong-password": "Falsches Passwort",
    "auth/too-many-requests": "Zu viele Versuche – bitte später erneut",
    "auth/email-already-in-use": "E-Mail wird bereits verwendet",
    "auth/weak-password": "Passwort ist zu schwach (mind. 6 Zeichen)",
  };
  return map[err.code] || "Login fehlgeschlagen";
}

/**
 * Bindet Listener an Loginformular &amp; Buttons (Login, Gast, Signup).
 * @function attachLoginFormHandlers
 * @param {Document|HTMLElement} [root=document] Root für Query-Selektoren
 * @returns {void}
 */
export function attachLoginFormHandlers(root = document) {
  const form = root.getElementById("loginForm");
  const loginBtn = root.getElementById("loginBtn");
  const guestBtn = root.getElementById("guestBtn");
  if (!(form &amp;&amp; loginBtn &amp;&amp; guestBtn)) return;
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = /** @type {HTMLInputElement} */ (
      root.getElementById("email")
    ).value.trim();
    const password = /** @type {HTMLInputElement} */ (
      root.getElementById("password")
    ).value;
    if (!email || !password) {
      setStatus("Bitte E-Mail &amp; Passwort eingeben", true);
      return;
    }
    loginBtn.disabled = true;
    try {
      await login(email, password);
    } catch (_) {
      // handled
    } finally {
      loginBtn.disabled = false;
    }
  });
  guestBtn.addEventListener("click", () => {
    guestLogin();
  });

  // Sign Up Button Handler
  const signupBtn = root.getElementById("signupBtn");
  if (signupBtn) {
    signupBtn.addEventListener("click", () => {
      showSignupForm();
    });
  }
}

/**
 * Ersetzt Inhalt durch Signup-Ansicht.
 * @private
 * @function showSignupForm
 */
function showSignupForm() {
  const root = document.getElementById("app");
  if (!root) return;
  const brand =
    '&lt;div class="brand-splash brand-fixed">&lt;img src="./img/img/header_logo.svg" alt="Join Logo" />&lt;/div>';
  root.innerHTML = brand + getSignupMarkup();
  bindSignupHandlers();
}

function getSignupMarkup() {
  /**
   * Erzeugt das Markup für die Signup-Form.
   * @private
   * @returns {string}
   */
  // Asset-Pfade angepasst (icons_signup Ordner existiert nicht -> Platzhalter / generische Icons)
  return /*html*/ `
  &lt;div class="signUp__view">
    &lt;div class="signUp__container">
      &lt;div class="headline__container">
        &lt;div class="goback" onclick="goBack()">
          &lt;img src="./img/icon/arrow-left-line.svg" alt="back" />
        &lt;/div>
          &lt;div class="headline__titleWrap">
            &lt;h1>Sign Up&lt;/h1>
            &lt;div class="signUp__separator" aria-hidden="true">&lt;/div>
          &lt;/div>
      &lt;/div>
      &lt;form id="signup" class="signUp__form" onsubmit="signUpSubmit(event)">
        &lt;div class="inputField__container inputField__container-margin24">
          &lt;input id="name" type="text" placeholder="Name" autocomplete="name" required />
          &lt;img class="inputField__username__icon" src="./img/icon/person.svg" alt="User" />
        &lt;/div>
        &lt;div class="inputField__container inputField__container-margin24">
          &lt;input id="email" type="email" placeholder="Email" autocomplete="email" required oninput="validateEmail()" />
          &lt;img class="inputField__username__icon" src="./img/icon/mail.svg" alt="Email" />
        &lt;/div>
        &lt;div class="inputField__container inputField__container-margin24">
          &lt;input id="password" type="password" placeholder="Password" autocomplete="new-password" required minlength="6" oninput="validatePassword();deleteMessageThatPasswordsDontMatch();" />
          &lt;img id="password__icon" class="inputField__password__icon" src="./img/icon/lock.svg" alt="Passwort anzeigen" onclick="showPassword('password')" />
        &lt;/div>
        &lt;div class="inputField__container">
          &lt;input id="password__confirm" type="password" placeholder="Confirm Password" autocomplete="new-password" required minlength="6" oninput="deleteMessageThatPasswordsDontMatch()" />
          &lt;img id="password__confirm__icon" class="inputField__password__icon" src="./img/icon/lock.svg" alt="Passwort anzeigen" onclick="showPassword('password__confirm')" />
        &lt;/div>
        &lt;div class="form__wrongPassword__container">&lt;div class="form__wrongPassword__message" id="form__wrongPassword__message">&lt;/div>&lt;/div>
        &lt;label class="check-box">
          &lt;input id="checkbox" type="checkbox" onchange="disableSignupButtonIfFormIsEmpty()" />
          &lt;span>Ich akzeptiere die &lt;a href="./privacyPolicy.html" class="signUp__privacyPolicy" target="_blank">Privacy Policy&lt;/a>&lt;/span>
        &lt;/label>
        &lt;div class="signUp__btn__container">
          &lt;button type="submit" id="btn__signUp" class="btn__signUp btn__disabled" disabled>Sign up&lt;/button>
        &lt;/div>
        &lt;div class="login-status" id="signupStatus" aria-live="polite">&lt;/div>
      &lt;/form>
    &lt;/div>
  &lt;/div>
  &lt;footer class="login-footer">
    &lt;button type="button" onclick="window.location.href='./pages/privacy_policy_external.html'">Privacy Policy&lt;/button>
    &lt;button type="button" onclick="window.location.href='./pages/legal_notice_external.html'">Legal Notice&lt;/button>
  &lt;/footer>
  `;
}

function bindSignupHandlers() {
  /**
   * Bindet Input-Listener für dynamische Aktivierung des Signup Buttons.
   * @private
   * @returns {void}
   */
  disableSignupButtonIfFormIsEmpty();
  const inputs = ["name", "email", "password", "password__confirm"];
  inputs.forEach((id) => {
    const el = document.getElementById(id);
    if (el) el.addEventListener("input", disableSignupButtonIfFormIsEmpty);
  });
}

// Globale Hilfsfunktionen (werden im Markup genutzt)
window.goBack = function goBack() {
  // Zurück zur Login-Ansicht
  const root = document.getElementById("app");
  if (!root) return;
  // Login neu anzeigen lassen
  window.dispatchEvent(
    new CustomEvent("auth-changed", { detail: { user: null } })
  );
};

/**
 * Formular-Submit Handler für Registrierung (global genutzt im Inline-Attribut).
 * @global
 * @async
 * @param {SubmitEvent} e Event
 */
window.signUpSubmit = async function signUpSubmit(e) {
  e.preventDefault();
  const nameEl = document.getElementById("name");
  const emailEl = document.getElementById("email");
  const pwEl = document.getElementById("password");
  const pw2El = document.getElementById("password__confirm");
  const statusEl = document.getElementById("signupStatus");
  if (!(nameEl &amp;&amp; emailEl &amp;&amp; pwEl &amp;&amp; pw2El)) return;
  const name = nameEl.value.trim();
  const email = emailEl.value.trim();
  const pw = pwEl.value;
  const pw2 = pw2El.value;
  if (pw !== pw2) {
    setWrongPasswordMessage("Passwörter stimmen nicht überein");
    return;
  }
  if (!document.getElementById("checkbox").checked) {
    setStatusInline("Bitte Datenschutz akzeptieren", true);
    return;
  }
  const btn = document.getElementById("btn__signUp");
  if (btn) btn.disabled = true;
  setStatusInline("Konto wird erstellt…");
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, pw);
    if (name) {
      try {
        await updateProfile(cred.user, { displayName: name });
      } catch (_) {}
    }
    setStatusInline("Konto erstellt – Anmeldung aktiv");
    dispatchAuthEvent();
  } catch (err) {
    setStatusInline(mapFirebaseError(err), true);
  } finally {
    if (btn) btn.disabled = false;
  }
};

/**
 * Prüft erforderliche Felder &amp; aktiviert/deaktiviert den Signup Button.
 * @global
 */
window.disableSignupButtonIfFormIsEmpty =
  function disableSignupButtonIfFormIsEmpty() {
    const requiredIds = ["name", "email", "password", "password__confirm"];
    const filled = requiredIds.every((id) => {
      const el = document.getElementById(id);
      return el &amp;&amp; el.value.trim();
    });
    const pw = (document.getElementById("password") || {}).value || "";
    const pw2 =
      (document.getElementById("password__confirm") || {}).value || "";
    const checkbox = document.getElementById("checkbox");
    const btn = document.getElementById("btn__signUp");
    const enable =
      filled &amp;&amp; pw.length >= 6 &amp;&amp; pw === pw2 &amp;&amp; checkbox &amp;&amp; checkbox.checked;
    if (btn) {
      btn.disabled = !enable;
      btn.classList.toggle("btn__disabled", !enable);
    }
  };

/**
 * Validiert E-Mail Format während der Eingabe.
 * @global
 */
window.validateEmail = function validateEmail() {
  const emailEl = document.getElementById("email");
  if (!emailEl) return;
  const val = emailEl.value.trim();
  if (!val) return;
  const ok = /.+@.+\..+/.test(val);
  if (!ok) setStatusInline("Ungültige E-Mail-Adresse", true);
  else clearInlineStatus();
};

/**
 * Validiert Passwort (Mindestlänge) während der Eingabe.
 * @global
 */
window.validatePassword = function validatePassword() {
  const pwEl = document.getElementById("password");
  if (!pwEl) return;
  if (pwEl.value.length &amp;&amp; pwEl.value.length &lt; 6) {
    setStatusInline("Passwort zu kurz (min. 6 Zeichen)", true);
  } else {
    clearInlineStatus();
  }
};

/**
 * Löscht Fehlermeldung zu passwort mismatch.
 * @global
 */
window.deleteMessageThatPasswordsDontMatch =
  function deleteMessageThatPasswordsDontMatch() {
    setWrongPasswordMessage("");
    clearInlineStatus();
  };

/**
 * Toggeln der Passwortsichtbarkeit für ein Feld.
 * @global
 * @param {string} id ID des Input Feldes
 */
window.showPassword = function showPassword(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.type = el.type === "password" ? "text" : "password";
};

/**
 * (Legacy Placeholder) Checkbox-Klick Handler.
 * @global
 */
window.checkBoxClicked = function checkBoxClicked() {
  // nicht benötigt – Checkbox nutzt native input – Placeholder falls im Markup referenziert
  disableSignupButtonIfFormIsEmpty();
};

function setWrongPasswordMessage(msg) {
  const el = document.getElementById("form__wrongPassword__message");
  if (el) el.textContent = msg;
}
function setStatusInline(msg, isError = false) {
  const el = document.getElementById("signupStatus");
  if (el) {
    el.textContent = msg;
    el.classList.toggle("error", !!isError);
  }
}
function clearInlineStatus() {
  setStatusInline("");
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-auth.html">auth</a></li><li><a href="module-firebase.html">firebase</a></li><li><a href="module-main.html">main</a></li></ul><h3>Global</h3><ul><li><a href="global.html#checkBoxClicked">checkBoxClicked</a></li><li><a href="global.html#deleteMessageThatPasswordsDontMatch">deleteMessageThatPasswordsDontMatch</a></li><li><a href="global.html#disableSignupButtonIfFormIsEmpty">disableSignupButtonIfFormIsEmpty</a></li><li><a href="global.html#showPassword">showPassword</a></li><li><a href="global.html#signUpSubmit">signUpSubmit</a></li><li><a href="global.html#validateEmail">validateEmail</a></li><li><a href="global.html#validatePassword">validatePassword</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Wed Oct 01 2025 09:48:01 GMT+0200 (Mitteleuropäische Sommerzeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
